<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Go on the toilet  | #11 - Concurrency is not parallelism</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.58.3" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/gott/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="#11 - Concurrency is not parallelism" />
<meta property="og:description" content="First two-sides episode!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jbszczepaniak.github.io/gott/episodes/episode11/" />
<meta property="article:published_time" content="2019-08-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-08-26T00:00:00+00:00" />
<meta itemprop="name" content="#11 - Concurrency is not parallelism">
<meta itemprop="description" content="First two-sides episode!">


<meta itemprop="datePublished" content="2019-08-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-08-26T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="530">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="#11 - Concurrency is not parallelism"/>
<meta name="twitter:description" content="First two-sides episode!"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://jbszczepaniak.github.io/gott/" class="f3 fw2 hover-white no-underline white-90 dib">
      Go on the toilet
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/gott/credits/" title="Credits page">
              Credits
            </a>
          </li>
          
        </ul>
      
      







<a href="https://github.com/jbszczepaniak/gott" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github‚Äî‚ÄîOpens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        EPISODES
      </p>
      <h1 class="f1 athelas mb1">#11 - Concurrency is not parallelism</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2019-08-26T00:00:00Z">August 26, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h2 id="get-pdf-here-gott-episode11-pdf"><a href="/gott/episode11.pdf">get pdf here</a> üñ®</h2>

<h1 id="left-side">Left side</h1>

<p>‚ë† I hope you&rsquo;ve started reading right here. This is the beginning of this episode. Let&rsquo;s get started with acknowledgment that both parallelism and concurrency deal with the same domain of doing many things &ldquo;at the same time&rdquo;. ‚Üí‚ë°</p>

<p>‚ë¢ This is concurrent work in action. You are reading two things at the same time, but you can be focused only on one of them at the time. This shows that a computer with a single CPU is able to perform concurrent tasks. Concurrency is really about how your program is structured. If a human being would be able to read one page with one eye, and the second with the other we would have parallel computing. Similarly, it is easy to add parallelism to the program that is written concurrently by using more processors. ‚Üí‚ë£</p>

<p>‚ë§
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() {
    files, _ := ioutil.<span style="color:#447fcf">ReadDir</span>(<span style="color:#ed9d13">&#34;.&#34;</span>)

    thumbnailsToUpload := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">string</span>)
    uploadDone := <span style="color:#24909d">make</span>(<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">bool</span>)
    <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">upload</span>(thumbnailsToUpload, uploadDone)

    wg := sync.WaitGroup{}
    <span style="color:#6ab825;font-weight:bold">for</span> _, file := <span style="color:#6ab825;font-weight:bold">range</span> files {
        <span style="color:#6ab825;font-weight:bold">if</span> strings.<span style="color:#447fcf">HasSuffix</span>(file.<span style="color:#447fcf">Name</span>(), <span style="color:#ed9d13">&#34;.png&#34;</span>) {
            wg.<span style="color:#447fcf">Add</span>(<span style="color:#3677a9">1</span>)
            <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">thumbnail</span>(file.<span style="color:#447fcf">Name</span>(), thumbnailsToUpload, &amp;wg)
        }
    }
    <span style="color:#999;font-style:italic">// Wait for all thumbnail jobs to finish.
</span><span style="color:#999;font-style:italic"></span>    wg.<span style="color:#447fcf">Wait</span>()
    <span style="color:#999;font-style:italic">// Close toUpload channel so that upload goroutine will
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">// know when to stop iterating over toUpload channel.
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#24909d">close</span>(toUpload)
    <span style="color:#999;font-style:italic">// Wait for uploadDone channel so receive so that program
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">// will now finish before launching all uploads.  
</span><span style="color:#999;font-style:italic"></span>    &lt;-uploadDone 
}</code></pre></div></p>

<p>Let&rsquo;s see how <code>thumbnail</code> and <code>upload</code> are defined. ‚Üí‚ë•</p>

<p>‚ë¶ This short program leverages go asynchronous model. It uses goroutines in order to make it faster.  ‚Üí‚ëß</p>

<h1 id="right-side">Right side</h1>

<p>‚ë° Did you see what just happened? You&rsquo;ve just switched a context. You&rsquo;ve just started working on different task of reading an article to the right site. ‚ë¢‚Üê</p>

<p>‚ë£ Let&rsquo;s think of an example of concurrent work to do that is small enough that will fit on one episode, yet realistic enough that you can relate to it. How about a thumbnailer? The idea will be to have a program that makes a thumbnail for every png file in given directory and uploads them somewhere. ‚ë§‚Üê</p>

<p>‚ë•
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">thumbnail</span>(path <span style="color:#6ab825;font-weight:bold">string</span>, thumbnails <span style="color:#6ab825;font-weight:bold">chan</span>&lt;- <span style="color:#6ab825;font-weight:bold">string</span>, wg *sync.WaitGroup) {
    <span style="color:#6ab825;font-weight:bold">defer</span> wg.<span style="color:#447fcf">Done</span>()

    <span style="color:#999;font-style:italic">// .. magic that generates smaller version of an image under `path`.
</span><span style="color:#999;font-style:italic"></span>    thumbnailPath := <span style="color:#447fcf">resizeImg</span>(path)

    thumbnails &lt;- thumbnailPath
}
Resizing an image is a CPU-bound task. 

<span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">upload</span>(paths &lt;-<span style="color:#6ab825;font-weight:bold">chan</span> <span style="color:#6ab825;font-weight:bold">string</span>, done <span style="color:#6ab825;font-weight:bold">chan</span>&lt;- <span style="color:#6ab825;font-weight:bold">bool</span>) {
    <span style="color:#6ab825;font-weight:bold">for</span> path := <span style="color:#6ab825;font-weight:bold">range</span> paths {
        <span style="color:#6ab825;font-weight:bold">go</span> <span style="color:#447fcf">uploadSingle</span>(path)
    }
    done &lt;- <span style="color:#6ab825;font-weight:bold">true</span>
}</code></pre></div>
This one is IO-bound, it has make a remote call. ‚ë¶‚Üê</p>

<p>‚ëß What is worth noting here is that this program can be run on a single core (by setting environment variable <code>GOMAXPROCS=1</code>) and we can still save time on executing upload goroutines because inside this goroutine we don&rsquo;t wait for the result of upload operation to finish (which is naive, but that&rsquo;s not the point).</p>

<p>Starting from Go 1.5 Release <code>GOMAXPROCS</code> environment variable defaults to the amount of CPU cores on the machine. If we have multi-core machine (which we probably have) and if we do not change the value of <code>GOMAXPROCS</code>, thumbnail function will also gain performance because the CPU will be able to do calculations exactly at the same time for many goroutines.</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://jbszczepaniak.github.io/gott/" >
    &copy; 2019 Go on the toilet
  </a>
    <div>







<a href="https://github.com/jbszczepaniak/gott" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github‚Äî‚ÄîOpens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





</div>
  </div>
</footer>

    

  <script src="/gott/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
